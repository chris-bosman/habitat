stages:
  - build
  - deploy

build:client:
  image: circleci/node
  stage: build
  cache: 
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - client/node_modules/
  before_script:
    - cd client
    - npm i
  script:
    - npm run build
  only:
    changes:
      - client/*
  except:
    refs:
      - master

build:server:
  image: circleci/node
  stage: build
  cache: 
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - server/node_modules/
  script:
    - cd server
    - npm i
    - npm run pack
    - mkdir packages
    - cd ..
    - zip -ur server/habitat.zip .ebextensions
    - mv server/habitat.zip server/packages
  artifacts:
    paths:
      - server/packages/habitat.zip
  only:
    changes:
      - server/*

build:infrastructure:
  image:
    name: hashicorp/terraform:full
    entrypoint: ["/bin/bash"]
  stage: build
  script:
    - cd infrastructure/aws
    - terraform init
    - terraform plan -out=plan
  artifacts:
    paths:
      - infrastructure/aws/plan
  only:
    changes:
      - infrastructure/*

deploy:client:
  image: circleci/node
  stage: deploy
  script:
    - npm i
    - npm run build-client
  only:
    refs:
      - master
    changes:
      - client/*

deploy:server:
  image: circleci/python
  stage: deploy
  before_script:
    - pip3 install awscli --upgrade --user
    - pip3 install awsebcli --upgrade --user
  script:
    - aws s3 sync server/packages s3://$AWS_S3_BUCKET/$SOFTWARE_VERSION.$CI_JOB_ID
    - aws s3 copy s3://$AWS_S3_BUCKET/$SOFTWARE_VERSION.$CI_JOB_ID/habitat.zip s3://$AWS_EB_S3_BUCKET/$SOFTWARE_VERSION.$CI_JOB_ID/habitat.zip
    - aws elasticbeanstalk create-application-vesion --application-name $AWS_EB_APP_NAME --version-label $SOFTWARE_VERSION.$CI_JOB_ID --source-bundle S3Bucket="$AWS_EB_S3_BUCKET",S3Key="$SOFTWARE_VERSION.$CI_JOB_ID/habitat.zip" --auto-create-application
    - eb deploy --version $SOFTWARE_VERSION.$CI_JOB_ID
    - eb setenv DB_PASS=$atlas_pw
  only:
    refs:
    - master
    changes:
      - server/*
  when: on_success
  dependencies:
    - build:server

deploy:infrastructure:
  image:
    name: hashicorp/terraform:full
    entrypoint: ["/bin/bash"]
  stage: deploy
  script:
    - cd infrastructure/aws
    - terraform init
    - terraform apply -auto-approve "plan"
  only:
    refs:
    - master
    changes:
      - infrastructure/*
  when: on_success
  dependencies:
    - build:infrastructure